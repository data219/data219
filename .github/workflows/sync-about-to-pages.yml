name: Sync README to GitHub Pages include

on:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: sync-readme-to-pages
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      # Set this secret in repo Settings → Secrets and variables → Actions.
      # Fine-grained PAT recommended:
      # - Resource owner: data219
      # - Repository access: Only select repositories → data219/data219.github.io
      # - Permissions: Contents: Read & Write
      PAGES_REPO_TOKEN: ${{ secrets.PAGES_REPO_TOKEN }}

    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4

      - name: Skip if token not configured
        if: ${{ env.PAGES_REPO_TOKEN == '' }}
        run: |
          echo "PAGES_REPO_TOKEN is not set. Skipping sync."
          exit 0

      - name: Checkout Pages repo
        if: ${{ env.PAGES_REPO_TOKEN != '' }}
        uses: actions/checkout@v4
        with:
          repository: data219/data219.github.io
          token: ${{ env.PAGES_REPO_TOKEN }}
          path: pages

      - name: Copy README to _includes/about.md
        if: ${{ env.PAGES_REPO_TOKEN != '' }}
        run: |
          mkdir -p pages/_includes
          cp README.md pages/_includes/about.md

      - name: Commit & push (only if changed)
        if: ${{ env.PAGES_REPO_TOKEN != '' }}
        working-directory: pages
        run: |
          if git diff --quiet -- _includes/about.md; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add _includes/about.md
          git commit -m "Update _includes/about.md from data219/README.md"
          git push
